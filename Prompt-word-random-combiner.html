<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æç¤ºè¯éšæœºç»„åˆå™¨ - æ”¶è—ç‰ˆ</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f7f6;
            padding: 20px;
            color: #333;
        }
        .main-layout {
            display: flex;
            max-width: 1300px; 
            margin: 0 auto;
            gap: 20px;
        }
        .container {
            flex: 3; 
            min-width: 600px;
            background: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .sidebar {
            flex: 1; 
            min-width: 300px;
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .sidebar-header h2 {
            margin: 0;
            color: #1e88e5;
        }
        /* åŠ å·æŒ‰é’®æ ·å¼ */
        .btn-add-combination {
            background-color: #4caf50;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 20px;
            line-height: 1;
            cursor: pointer;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn-add-combination:hover {
            background-color: #45a049;
        }
        /* åˆ—è¡¨æ ·å¼ */
        #combination-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 70vh; 
            overflow-y: auto; 
        }
        .combination-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .combination-item:hover {
            background-color: #f5f5f5;
        }
        .item-name {
            font-weight: bold;
            color: #333;
            flex-grow: 1;
            padding-right: 10px;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis; 
        }
        .item-delete {
            background: #f44336;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.2s;
        }
        .item-delete:hover {
            opacity: 1;
        }
        
        /* æŒ‰é’®å’Œè¾“å‡ºæ ·å¼ */
        h1 { text-align: center; color: #1e88e5; margin-bottom: 30px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        .input-group textarea { width: 100%; height: 100px; padding: 10px; border: 1px solid #ccc; border-radius: 6px; resize: vertical; box-sizing: border-box; font-size: 14px; }
        .btn { display: block; width: 100%; padding: 12px; color: white; border: none; border-radius: 6px; font-size: 18px; cursor: pointer; transition: background-color 0.3s; box-sizing: border-box; text-align: center; }
        .btn-generate { background-color: #4caf50; }
        .btn-generate:hover { background-color: #45a049; }
        .btn-save { background-color: #ff9800; }
        .btn-save:hover { background-color: #fb8c00; }
        .btn-load { background-color: #2196f3; }
        .btn-load:hover { background-color: #1e88e5; }
        
        #output-area { flex: 1; padding: 15px; border: 2px solid #1e88e5; border-radius: 6px; background-color: #e3f2fd; word-break: break-all; font-size: 16px; font-weight: 500; }
        .note { margin-top: 20px; text-align: center; color: #888; font-size: 12px; }
        .button-group { display: flex; gap: 10px; margin-bottom: 20px; }
        #file-input-label { flex: 1; cursor: pointer; }
        #file-input { display: none; }
    </style>
</head>
<body>

<div class="main-layout">
    <div class="container">
        <h1>ğŸ¨ æç¤ºè¯éšæœºç»„åˆå™¨</h1>
        <p>å°†æ¯ç»„æç¤ºè¯ç²˜è´´åœ¨å¯¹åº”çš„æ–‡æœ¬æ¡†ä¸­ï¼Œæ¯è¡Œä¸€ä¸ªæç¤ºè¯ã€‚æ•°æ®å°†è‡ªåŠ¨ä¿å­˜åœ¨æµè§ˆå™¨ä¸­ã€‚</p>
        
        <div class="grid">
            <div class="input-group"><label for="ä¸ä¿®æ”¹çš„">1. ä¸ä¿®æ”¹çš„æç¤ºè¯ (åŸºåº•)</label><textarea id="ä¸ä¿®æ”¹çš„"></textarea></div>
            <div class="input-group"><label for="å¥—è£…">2. å¥—è£…</label><textarea id="å¥—è£…"></textarea></div>
            <div class="input-group"><label for="ä¸Šè£…">3. ä¸Šè£…</label><textarea id="ä¸Šè£…"></textarea></div>
            <div class="input-group"><label for="ä¸‹è£…">4. ä¸‹è£…</label><textarea id="ä¸‹è£…"></textarea></div>
            <div class="input-group"><label for="èº«ä½“é…é¥°">5. èº«ä½“é…é¥°</label><textarea id="èº«ä½“é…é¥°"></textarea></div>
            <div class="input-group"><label for="å‰å‘">6a. å‰å‘</label><textarea id="å‰å‘"></textarea></div>
            <div class="input-group"><label for="åå‘">6b. åå‘</label><textarea id="åå‘"></textarea></div>
            <div class="input-group"><label for="å®Œæ•´å‘å‹">6c. å®Œæ•´å‘å‹</label><textarea id="å®Œæ•´å‘å‹"></textarea></div>
            <div class="input-group"><label for="å‘è‰²">7. å‘è‰²</label><textarea id="å‘è‰²"></textarea></div>
            <div class="input-group"><label for="å§¿åŠ¿">8. å§¿åŠ¿</label><textarea id="å§¿åŠ¿"></textarea></div>
            <div class="input-group"><label for="é•œå¤´">9. é•œå¤´</label><textarea id="é•œå¤´"></textarea></div>
        </div>

        <div class="button-group">
            <label for="file-input" id="file-input-label">
                <div class="btn btn-load">ğŸ“¤ åŠ è½½åˆ†ç±»æç¤ºè¯ (.txt)</div>
                <input type="file" id="file-input" accept=".txt" onchange="loadFromTXT(event)">
            </label>
            <button onclick="saveToTXT()" class="btn btn-save" style="flex: 1;">ğŸ’¾ ä¿å­˜åˆ†ç±»æç¤ºè¯ (.txt)</button>
        </div>

        <button onclick="generatePrompt()" class="btn btn-generate">ç”Ÿæˆç»„åˆæç¤ºè¯</button>

        <div style="margin-top: 30px; display: flex;">
            <div id="output-area" style="flex: 1;">ç‚¹å‡»â€œç”Ÿæˆç»„åˆæç¤ºè¯â€æŒ‰é’®...</div>
        </div>

        <div class="note">
            æ³¨æ„ï¼šæœè£…éƒ¨åˆ†ä¼šéšæœºé€‰æ‹© "å¥—è£…" æˆ– "ä¸Šè£… + ä¸‹è£…"ã€‚<br>
            **å‘å‹éƒ¨åˆ†ä¼šéšæœºé€‰æ‹© "å‰å‘ + åå‘" æˆ– "å®Œæ•´å‘å‹"**ã€‚<br>
            æ‰€æœ‰è¾“å…¥å†…å®¹ä¼šè‡ªåŠ¨ä¿å­˜åœ¨æ‚¨æµè§ˆå™¨çš„æœ¬åœ°å­˜å‚¨ (Local Storage) ä¸­ã€‚
        </div>
    </div>

    <div class="sidebar">
        <div class="sidebar-header">
            <h2>ç»„åˆæ”¶è—å¤¹</h2>
            <button onclick="promptAndSaveCombination()" class="btn-add-combination" title="æ‰‹åŠ¨æ·»åŠ æ–°ç»„åˆ">+</button>
        </div>
        <p style="font-size: 12px; color: #888;">ç‚¹å‡»åˆ—è¡¨é¡¹å¯å¤åˆ¶å†…å®¹</p>
        <ul id="combination-list">
            </ul>
    </div>
</div>

<script>
    // â­ï¸ æ›´æ”¹ï¼šæ›´æ–° CATEGORIES åˆ—è¡¨ä»¥åŒ…å«æ–°çš„å‘å‹åˆ†ç±»
    const CATEGORIES = [
        "ä¸ä¿®æ”¹çš„", "å¥—è£…", "ä¸Šè£…", "ä¸‹è£…", "èº«ä½“é…é¥°", 
        "å‰å‘", "åå‘", "å®Œæ•´å‘å‹", // æ–°çš„å‘å‹åˆ†ç±»
        "å‘è‰²", "å§¿åŠ¿", "é•œå¤´"
    ];
    const COMBINATIONS_KEY = "prompt_combinations"; 

    function loadData() {
        CATEGORIES.forEach(id => {
            const data = localStorage.getItem(`prompt_${id}`);
            if (data) {
                document.getElementById(id).value = data;
            }
        });
        renderCombinations();
    }

    function saveData() {
        CATEGORIES.forEach(id => {
            const textarea = document.getElementById(id);
            localStorage.setItem(`prompt_${id}`, textarea.value);
        });
    }
    
    function selectRandomPrompt(id) {
        const text = document.getElementById(id).value;
        const prompts = text.split('\n')
                            .map(p => p.trim())
                            .filter(p => p.length > 0);
        
        return prompts.length > 0 ? prompts[Math.floor(Math.random() * prompts.length)] : "";
    }

    function loadCombinations() {
        const data = localStorage.getItem(COMBINATIONS_KEY);
        return data ? JSON.parse(data) : [];
    }

    function saveCombinations(combinations) {
        localStorage.setItem(COMBINATIONS_KEY, JSON.stringify(combinations));
    }

    // æç¤ºç”¨æˆ·è¾“å…¥æç¤ºè¯å’Œå‘½å
    function promptAndSaveCombination() {
        const defaultName = `ç»„åˆ #${Date.now() % 10000}`;
        
        // ä½¿ç”¨ prompt() å¼¹çª—è¦æ±‚ç”¨æˆ·è¾“å…¥æç¤ºè¯ï¼Œå¹¶å°è¯•é¢„å¡«å½“å‰è¾“å‡ºåŒºçš„å†…å®¹
        const promptText = prompt("è¯·è¾“å…¥æ‚¨æƒ³æ”¶è—çš„ç»„åˆæç¤ºè¯:", document.getElementById("output-area").innerText.trim());

        if (promptText === null || !promptText.trim()) {
            return; 
        }

        // æç¤ºç”¨æˆ·è¾“å…¥åç§°
        const name = prompt("è¯·ä¸ºæ­¤ç»„åˆå‘½åï¼š", defaultName);

        if (name) {
            const combinations = loadCombinations();
            combinations.push({ 
                name: name.trim() || defaultName, 
                prompt: promptText.trim() 
            });
            saveCombinations(combinations);
            renderCombinations();
            alert(`ç»„åˆ "${name.trim()}" å·²æˆåŠŸæ”¶è—!`);
        }
    }

    function renderCombinations() {
        const listElement = document.getElementById("combination-list");
        listElement.innerHTML = ''; 
        const combinations = loadCombinations();

        if (combinations.length === 0) {
            listElement.innerHTML = '<li style="color: #999; font-size: 14px;">æš‚æ— æ”¶è—çš„ç»„åˆã€‚</li>';
            return;
        }

        combinations.forEach((item, index) => {
            const li = document.createElement('li');
            li.className = 'combination-item';
            li.title = item.prompt; 
            li.innerHTML = `
                <span class="item-name">${item.name}</span>
                <button class="item-delete" data-index="${index}">åˆ é™¤</button>
            `;

            li.onclick = (e) => {
                if (e.target.className.includes('item-delete')) return; 

                navigator.clipboard.writeText(item.prompt).then(() => {
                    alert(`ç»„åˆ "${item.name}" å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼`);
                }).catch(err => {
                    console.error('å¤åˆ¶å¤±è´¥:', err);
                    alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ï¼š\n' + item.prompt);
                });
            };

            const deleteButton = li.querySelector('.item-delete');
            deleteButton.onclick = (e) => {
                e.stopPropagation(); 
                if (confirm(`ç¡®å®šè¦åˆ é™¤ç»„åˆ "${item.name}" å—ï¼Ÿ`)) {
                    deleteCombination(index);
                }
            };
            
            listElement.appendChild(li);
        });
    }

    function deleteCombination(index) {
        let combinations = loadCombinations();
        if (index >= 0 && index < combinations.length) {
            combinations.splice(index, 1); 
            saveCombinations(combinations);
            renderCombinations();
        }
    }


    function saveToTXT() {
        saveData(); 

        let content = "";
        CATEGORIES.forEach(id => {
            const textarea = document.getElementById(id);
            content += `== ${id} ==\n`;
            content += textarea.value.trim() + "\n\n";
        });

        const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'æç¤ºè¯_åˆ†ç±»å¤‡ä»½.txt';
        
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);

        alert("å·²å°†æ‰€æœ‰åˆ†ç±»æç¤ºè¯ä¿å­˜åˆ° 'æç¤ºè¯_åˆ†ç±»å¤‡ä»½.txt' æ–‡ä»¶ã€‚");
    }

    function loadFromTXT(event) {
        const file = event.target.files[0];
        if (!file) { return; }

        const reader = new FileReader();
        reader.onload = function(e) {
            const text = e.target.result;
            const lines = text.split('\n');
            let currentCategory = null;
            const categoryContents = {};

            CATEGORIES.forEach(id => { categoryContents[id] = []; });

            lines.forEach(line => {
                const trimmedLine = line.trim();
                const match = trimmedLine.match(/^== (.*?) ==$/); 

                if (match) {
                    const categoryName = match[1];
                    currentCategory = CATEGORIES.includes(categoryName) ? categoryName : null;
                } else if (currentCategory && trimmedLine) {
                    categoryContents[currentCategory].push(trimmedLine);
                }
            });

            CATEGORIES.forEach(id => {
                document.getElementById(id).value = categoryContents[id].join('\n');
            });

            saveData(); 
            alert("å·²æˆåŠŸä»æ–‡ä»¶åŠ è½½åˆ†ç±»æç¤ºè¯ï¼");
            event.target.value = ''; 
        };

        reader.readAsText(file);
    }

    function generatePrompt() {
        saveData();

        const allParts = [];
        // 1. ä¸ä¿®æ”¹çš„æç¤ºè¯ (åŸºåº•)
        const immutable = selectRandomPrompt("ä¸ä¿®æ”¹çš„");
        if (immutable) {
            allParts.push(immutable);
        }

        // 2. æœè£…éƒ¨åˆ† (å¥—è£… æˆ– ä¸Šè£… + ä¸‹è£…)
        let clothingPrompt = "";
        const selectSet = Math.random() < 0.5;

        if (selectSet) {
            clothingPrompt = selectRandomPrompt("å¥—è£…");
        } else {
            const top = selectRandomPrompt("ä¸Šè£…");
            const bottom = selectRandomPrompt("ä¸‹è£…");
            const tempParts = [top, bottom].filter(p => p);
            clothingPrompt = tempParts.join(", ");
        }

        if (clothingPrompt) {
            allParts.push(clothingPrompt);
        }
        
        // â­ï¸ æ›´æ”¹ï¼šæ–°çš„å‘å‹é€‰æ‹©é€»è¾‘ (å‰å‘ + åå‘ æˆ– å®Œæ•´å‘å‹)
        let hairstylePrompt = "";
        const useFullHairstyle = Math.random() < 0.5; // 50% çš„å‡ ç‡é€‰æ‹©å®Œæ•´å‘å‹

        if (useFullHairstyle) {
            // é€‰é¡¹ 1: å®Œæ•´å‘å‹
            hairstylePrompt = selectRandomPrompt("å®Œæ•´å‘å‹");
        } else {
            // é€‰é¡¹ 2: å‰å‘ + åå‘
            const front = selectRandomPrompt("å‰å‘");
            const back = selectRandomPrompt("åå‘");
            const tempParts = [front, back].filter(p => p);
            hairstylePrompt = tempParts.join(", ");
        }

        if (hairstylePrompt) {
            allParts.push(hairstylePrompt);
        }
        // â­ï¸ æ›´æ”¹ï¼šå‘å‹é€‰æ‹©é€»è¾‘ç»“æŸ

        // 3. å‰©ä½™é…é¥°å’Œè®¾ç½®
        // âš ï¸ æ³¨æ„ï¼šè¿™é‡Œç§»é™¤äº†åŸæ¥çš„ "å‘å‹" å­—æ®µ
        const accessoryCategories = ["èº«ä½“é…é¥°", "å‘è‰²", "å§¿åŠ¿", "é•œå¤´"]; 
        accessoryCategories.forEach(id => {
            const prompt = selectRandomPrompt(id);
            if (prompt) {
                allParts.push(prompt);
            }
        });

        const finalPrompt = allParts.join(", ");
        document.getElementById("output-area").innerText = finalPrompt || "æœªç”Ÿæˆä»»ä½•æç¤ºè¯ï¼Œè¯·æ£€æŸ¥è¾“å…¥æ˜¯å¦ä¸ºç©ºã€‚";
    }

    window.onload = loadData;
</script>

</body>
</html>