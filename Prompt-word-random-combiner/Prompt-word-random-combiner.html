<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æç¤ºè¯éšæœºç»„åˆå™¨</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f7f6; padding: 20px; color: #333; }
        .main-layout { display: flex; max-width: 1300px; margin: 0 auto; gap: 20px; }
        .container { flex: 3; min-width: 600px; background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); }
        .sidebar { flex: 1; min-width: 300px; background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); }
        .sidebar-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-bottom: 15px; }
        h1, .sidebar-header h2 { color: #1e88e5; }
        .btn-add-combination { background-color: #4caf50; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; font-size: 20px; cursor: pointer; transition: background-color 0.3s; display: flex; align-items: center; justify-content: center; }
        #combination-list { list-style: none; padding: 0; margin: 0; max-height: 50vh; overflow-y: auto; margin-bottom: 20px; }
        .combination-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #eee; cursor: pointer; }
        .item-name { font-weight: bold; flex-grow: 1; }
        .item-delete { background: #f44336; color: white; border: none; border-radius: 4px; padding: 4px 8px; font-size: 12px; cursor: pointer; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .input-group textarea { width: 100%; height: 100px; padding: 10px; border: 1px solid #ccc; border-radius: 6px; resize: vertical; box-sizing: border-box; }
        .btn { display: block; width: 100%; padding: 12px; color: white; border: none; border-radius: 6px; font-size: 18px; cursor: pointer; }
        .btn-generate { background-color: #4caf50; }
        .btn-save { background-color: #ff9800; }
        .btn-load { background-color: #2196f3; }
        #output-area { flex: 1; padding: 15px; border: 2px solid #1e88e5; border-radius: 6px; background-color: #e3f2fd; word-break: break-all; white-space: pre-wrap; }
        .button-group { display: flex; gap: 10px; margin-bottom: 20px; }
        #file-input { display: none; }
        .batch-area { border-top: 2px solid #e0e0e0; padding-top: 15px; margin-top: 15px; }
        .batch-input-group { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .batch-input-group input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 6px; text-align: center; }
        .btn-batch-generate { background-color: #00bcd4; font-size: 16px; padding: 10px; }
        #notification-box { position: fixed; bottom: 20px; left: 20px; background-color: #333; color: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        #notification-box.show { opacity: 1; visibility: visible; }
        #notification-box.error { background-color: #f44336; }
        #notification-box.success { background-color: #4CAF50; }
        #notification-box.info { background-color: #2196F3; }
        .mode-switcher { display: flex; justify-content: center; margin-bottom: 20px; gap: 10px; }
        .mode-btn { padding: 10px 20px; font-size: 16px; cursor: pointer; border: 2px solid #1e88e5; background-color: #fff; color: #1e88e5; border-radius: 8px; }
        .mode-btn.active { background-color: #1e88e5; color: #fff; }
        .mode-container { display: none; }
        .mode-container.active { display: block; }
        .dynamic-section, .custom-section { border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; background-color: #fafafa; }
        .dynamic-section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .dynamic-section-header input { font-weight: bold; border: none; border-bottom: 1px solid #ccc; background: transparent; font-size: 16px; flex-grow: 1; }
        .btn-delete-section { background: #e57373; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; }
        .choice-group { border: 2px dashed #42a5f5; border-radius: 8px; padding: 10px; margin-bottom: 20px; background-color: #e3f2fd; grid-column: 1 / -1; display: flex; gap: 15px; align-items: center; }
        .choice-group .input-group { flex: 1; margin-bottom: 0; }
        .choice-group-divider { font-size: 18px; font-weight: bold; color: #1e88e5; }
    </style>
</head>
<body>
<div class="main-layout">
    <div class="container" id="main-container"></div>
    <div class="sidebar" id="sidebar-container"></div>
</div>
<div id="notification-box"></div>

<script>
const app = {
    state: {},
    mainContainer: document.getElementById('main-container'),
    sidebarContainer: document.getElementById('sidebar-container'),

    init() {
        this.loadState();
        this.render();
    },

    getInitialState() {
        const initialState = {
            currentMode: 'portrait',
            portrait: { static: {}, dynamic: [] },
            custom: { dynamic: [] },
            listToJson: { content: '' },
            favorites: []
        };
        ["ä¸ä¿®æ”¹çš„", "å¥—è£…", "ä¸Šè£…", "ä¸‹è£…", "èº«ä½“é…é¥°", "å‰å‘", "åå‘", "å®Œæ•´å‘å‹", "å‘è‰²", "è¡¨æƒ…", "å§¿åŠ¿", "é•œå¤´", "å…‰ç…§", "åœºæ™¯"].forEach(id => initialState.portrait.static[id] = "");
        return initialState;
    },

    render() {
        this.mainContainer.innerHTML = `
            <h1>ğŸ¨ æç¤ºè¯éšæœºç»„åˆå™¨</h1>
            <div class="mode-switcher">
                <button class="mode-btn ${this.state.currentMode === 'portrait' ? 'active' : ''}" onclick="app.switchMode('portrait')">ğŸ‘¤ äººåƒæ¨¡å¼</button>
                <button class="mode-btn ${this.state.currentMode === 'custom' ? 'active' : ''}" onclick="app.switchMode('custom')">âœ¨ è‡ªå®šä¹‰æ¨¡å¼</button>
                <button class="mode-btn ${this.state.currentMode === 'listToJson' ? 'active' : ''}" onclick="app.switchMode('listToJson')">ğŸ“ åˆ—è¡¨åˆ°JSON</button>
            </div>
            <div id="portrait-mode-container" class="mode-container ${this.state.currentMode === 'portrait' ? 'active' : ''}">${this.renderPortraitMode(this.state.portrait)}</div>
            <div id="custom-mode-container" class="mode-container ${this.state.currentMode === 'custom' ? 'active' : ''}">${this.renderCustomMode(this.state.custom)}</div>
            <div id="listToJson-mode-container" class="mode-container ${this.state.currentMode === 'listToJson' ? 'active' : ''}">${this.renderListToJsonMode(this.state.listToJson)}</div>
            <div style="margin-top: 20px; display: flex;">
                <div id="output-area">ç‚¹å‡»â€œç”Ÿæˆâ€æŒ‰é’®...</div>
            </div>
        `;
        this.sidebarContainer.innerHTML = this.renderSidebar();
    },

    renderSharedControls(isLineByLine = false) {
        const generateButtonText = isLineByLine ? 'ç”Ÿæˆå¹¶ä¸‹è½½JSON' : 'ç”Ÿæˆç»„åˆæç¤ºè¯å¹¶å¤åˆ¶';
        return `
            <div class="button-group">
                <label class="btn btn-load"><input type="file" id="file-input" style="display:none;" onchange="app.loadFromFile(event)">ğŸ“¤ åŠ è½½æ¨¡å¼ (.txt/.json)</label>
                <button class="btn btn-save" onclick="app.saveToFile()">ğŸ’¾ ä¿å­˜æ¨¡å¼ (.json)</button>
            </div>
            <button class="btn btn-generate" onclick="app.generatePrompt()">${generateButtonText}</button>
        `;
    },

    renderPortraitMode(data) {
        return `
            <p>å°†æ¯ç»„æç¤ºè¯ç²˜è´´åœ¨å¯¹åº”çš„æ–‡æœ¬æ¡†ä¸­ï¼Œæ¯è¡Œä¸€ä¸ªæç¤ºè¯ã€‚</p>
            <div class="grid">
                <div class="input-group" style="grid-column: 1 / -1;"><label>1. ä¸ä¿®æ”¹çš„æç¤ºè¯ (åŸºåº•)</label><textarea oninput="app.updateState(event, 'portrait', 'static', 'ä¸ä¿®æ”¹çš„')">${data.static['ä¸ä¿®æ”¹çš„']}</textarea></div>
                <div class="choice-group">
                    <div class="input-group"><label>2a. å¥—è£…</label><textarea oninput="app.updateState(event, 'portrait', 'static', 'å¥—è£…')">${data.static['å¥—è£…']}</textarea></div>
                    <div class="choice-group-divider">æˆ–</div>
                    <div class="input-group"><label>2b. ä¸Šè£…</label><textarea oninput="app.updateState(event, 'portrait', 'static', 'ä¸Šè£…')">${data.static['ä¸Šè£…']}</textarea></div>
                    <div class="input-group"><label>2c. ä¸‹è£…</label><textarea oninput="app.updateState(event, 'portrait', 'static', 'ä¸‹è£…')">${data.static['ä¸‹è£…']}</textarea></div>
                </div>
                <div class="choice-group">
                     <div class="input-group"><label>3a. å®Œæ•´å‘å‹</label><textarea oninput="app.updateState(event, 'portrait', 'static', 'å®Œæ•´å‘å‹')">${data.static['å®Œæ•´å‘å‹']}</textarea></div>
                    <div class="choice-group-divider">æˆ–</div>
                    <div class="input-group"><label>3b. å‰å‘</label><textarea oninput="app.updateState(event, 'portrait', 'static', 'å‰å‘')">${data.static['å‰å‘']}</textarea></div>
                    <div class="input-group"><label>3c. åå‘</label><textarea oninput="app.updateState(event, 'portrait', 'static', 'åå‘')">${data.static['åå‘']}</textarea></div>
                </div>
                ${Object.keys(data.static).filter(k => !['ä¸ä¿®æ”¹çš„','å¥—è£…','ä¸Šè£…','ä¸‹è£…','å®Œæ•´å‘å‹','å‰å‘','åå‘'].includes(k)).map(key => `<div class="input-group"><label>${key}</label><textarea oninput="app.updateState(event, 'portrait', 'static', '${key}')">${data.static[key]}</textarea></div>`).join('')}
            </div>
            <div class="grid">${this.renderDynamicSections(data.dynamic, ['portrait', 'dynamic'])}</div>
            <button class="btn" style="background-color: #607d8b; margin-bottom: 20px;" onclick="app.addSection(['portrait', 'dynamic'], 'combinatorial')">+ æ·»åŠ ç»„åˆè¾“å…¥æ¡†</button>
            ${this.renderSharedControls()}
        `;
    },

    renderCustomMode(data) {
        return `
            <p>è‡ªç”±æ·»åŠ ã€ç»„åˆå’Œé€‰æ‹©ä½ çš„æç¤ºè¯æ¨¡å—ã€‚</p>
            <div class="grid">${this.renderDynamicSections(data.dynamic, ['custom', 'dynamic'])}</div>
            <div class="button-group" style="flex-direction: column;">
                <button class="btn" style="background-color: #009688;" onclick="app.addSection(['custom', 'dynamic'], 'standard')">+ æ·»åŠ æ–°åŒºå—</button>
                <button class="btn" style="background-color: #607d8b;" onclick="app.addSection(['custom', 'dynamic'], 'combinatorial')">+ æ·»åŠ ç»„åˆè¾“å…¥æ¡†</button>
            </div>
            ${this.renderSharedControls()}
        `;
    },

    renderListToJsonMode(data) {
         return `
            <p>åœ¨æ­¤å¤„ç²˜è´´æ‚¨çš„æç¤ºè¯åˆ—è¡¨ï¼Œæ¯è¡Œä¸€ä¸ªã€‚å°†ä¸ºæ‚¨ç”Ÿæˆæ ‡å‡†çš„JSONæ•°ç»„ã€‚</p>
            <div class="input-group">
                <textarea style="height: 400px;" oninput="app.updateState(event, 'listToJson', 'content')">${data.content}</textarea>
            </div>
            ${this.renderSharedControls(true)}
        `;
    },

    renderDynamicSections(sections, path) {
        return sections.map((section, index) => {
            const currentPath = [...path, index];
            return this.renderStandardOrCombinatorial(section, currentPath);
        }).join('');
    },

    renderStandardOrCombinatorial(section, path) {
        const title = section.title;
        return `
        <div class="${section.type === 'combinatorial' ? 'dynamic-section' : 'custom-section'}">
            <div class="dynamic-section-header">
                <input type="text" value="${title}" oninput="app.updateState(event, ...${JSON.stringify(path)}, 'title')">
                <button class="btn-delete-section" onclick="app.deleteSection(${JSON.stringify(path)})">åˆ é™¤</button>
            </div>
            <textarea oninput="app.updateState(event, ...${JSON.stringify(path)}, 'content')">${section.content}</textarea>
        </div>`;
    },

    renderSidebar() {
        const batchArea = this.state.currentMode === 'lineByLine' ? '' : `
            <div class="batch-area">
                <h3>ğŸš€ æ‰¹é‡ç”Ÿæˆå™¨</h3>
                <div class="batch-input-group"><label for="batch-count">ç”Ÿæˆæ•°é‡:</label><input type="number" id="batch-count" value="10" min="1"></div>
                <button class="btn btn-batch-generate" onclick="app.batchGenerate()">æ‰¹é‡ç”Ÿæˆå¹¶ä¿å­˜</button>
            </div>`;
        return `
            <div class="sidebar-header"><h2>ç»„åˆæ”¶è—å¤¹</h2><button class="btn-add-combination" onclick="app.addFavorite()">+</button></div>
            <ul id="combination-list">
                ${this.state.favorites.map((fav, index) => `
                <li class="combination-item" title="${fav.prompt}">
                    <span class="item-name" onclick="app.copyToClipboard('${fav.prompt.replace(/'/g, "\\'")}', 'ç»„åˆ')">${fav.name}</span>
                    <button class="item-delete" onclick="app.deleteFavorite(${index})">åˆ é™¤</button>
                </li>`).join('') || '<li style="color: #999;">æš‚æ— æ”¶è—ã€‚</li>'}
            </ul>
            ${batchArea}
        `;
    },

    getStateByPath(path) { return path.reduce((acc, key) => acc[key], this.state); },

    updateState(event, ...path) {
        const target = this.getStateByPath(path.slice(0, -1));
        target[path[path.length - 1]] = event.target.value;
        this.saveState();
    },
    addSection(path, type) {
        const target = this.getStateByPath(path);
        target.push({ type, title: 'æ–°åŒºå—', content: '' });
        this.saveState(); this.render();
    },
    deleteSection(path) {
        const key = path.pop();
        this.getStateByPath(path).splice(key, 1);
        this.saveState(); this.render();
    },
    switchMode(mode) {
        this.state.currentMode = mode;
        this.saveState(); this.render();
    },
    addFavorite() {
        const promptText = document.getElementById('output-area').innerText;
        const name = prompt("è¯·ä¸ºæ­¤ç»„åˆå‘½åï¼š", `ç»„åˆ #${this.state.favorites.length + 1}`);
        if (name && promptText && !promptText.startsWith('ç‚¹å‡»â€œç”Ÿæˆâ€')) {
            this.state.favorites.push({ name, prompt: promptText });
            this.saveState(); this.render();
        }
    },
    deleteFavorite(index) {
        this.state.favorites.splice(index, 1);
        this.saveState(); this.render();
    },
    copyToClipboard(text, type) {
        navigator.clipboard.writeText(text).then(() => this.notify(`${type}å·²å¤åˆ¶!`, 'success')).catch(() => this.notify('å¤åˆ¶å¤±è´¥', 'error'));
    },

    saveState() {
        localStorage.setItem('promptCombinerState', JSON.stringify(this.state));
    },
    loadState() {
        const savedState = localStorage.getItem('promptCombinerState');
        if (savedState) {
            try {
                const parsed = JSON.parse(savedState);
                 if (!parsed.listToJson) {
                    parsed.listToJson = { content: '' };
                }
                this.state = parsed;
            } catch {
                this.state = this.getInitialState();
            }
        } else {
            this.state = this.getInitialState();
        }
    },
    saveToFile() {
        try {
            const blob = new Blob([JSON.stringify(this.state, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `prompt_combiner_state.json`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            this.notify('çŠ¶æ€å·²ä¿å­˜åˆ°.jsonæ–‡ä»¶!', 'success');
        } catch (e) { this.notify('ä¿å­˜å¤±è´¥!', 'error'); console.error(e); }
    },
    loadFromFile(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const text = e.target.result;
            try {
                const loadedState = JSON.parse(text);
                if (loadedState.currentMode && loadedState.portrait && loadedState.custom) {
                    this.state = loadedState;
                    this.saveState(); this.render();
                    this.notify('çŠ¶æ€åŠ è½½æˆåŠŸ!', 'success');
                } else { throw new Error("Invalid state file"); }
            } catch (err) { this.loadLegacy(text); }
        };
        reader.readAsText(file);
        event.target.value = '';
    },
    loadLegacy(text) {
        if (this.state.currentMode !== 'portrait') {
            this.notify('æ—§ç‰ˆæ–‡ä»¶åªèƒ½åœ¨äººåƒæ¨¡å¼ä¸‹åŠ è½½ã€‚', 'error'); return;
        }
        const newState = this.getInitialState();
        let currentCategory = null;
        text.split('\n').forEach(line => {
            const trimmedLine = line.trim();
            if (trimmedLine.startsWith('==') && trimmedLine.endsWith('==')) {
                currentCategory = trimmedLine.substring(3, trimmedLine.length - 3).trim();
            } else if (currentCategory && newState.portrait.static.hasOwnProperty(currentCategory)) {
                newState.portrait.static[currentCategory] += line + '\n';
            }
        });
        Object.keys(newState.portrait.static).forEach(key => newState.portrait.static[key] = newState.portrait.static[key].trim());
        this.state = newState;
        this.saveState(); this.render();
        this.notify('æ—§ç‰ˆæ–‡ä»¶åŠ è½½æˆåŠŸ!', 'success');
    },

    generatePrompt() {
        const outputArea = document.getElementById("output-area");
        if (this.state.currentMode === 'listToJson') {
            const jsonString = this.generateListToJson();
            outputArea.innerText = jsonString;
            this.saveJsonToFile(jsonString, 'list_prompts.json');
        } else {
            const result = this.generateSinglePrompt();
            outputArea.innerText = result || "æœªç”Ÿæˆä»»ä½•æç¤ºè¯ï¼Œè¯·æ£€æŸ¥è¾“å…¥æ˜¯å¦ä¸ºç©ºã€‚";
            if (result) this.copyToClipboard(result, "æç¤ºè¯");
        }
    },
    generateSinglePrompt() {
        const allParts = [];
        const selectRandom = (content) => {
            if (!content) return "";
            const prompts = content.split('\n').map(p => p.trim()).filter(p => p.length > 0);
            return prompts.length > 0 ? prompts[Math.floor(Math.random() * prompts.length)] : "";
        };
        const processBlock = (block) => {
            if (!block || !block.content) return "";
            const prompt = selectRandom(block.content);
            if (!prompt) return "";
            return block.type === 'combinatorial' && block.title ? `${block.title}, ${prompt}` : prompt;
        };
        const generateFromBlocks = (blocks) => {
            let parts = [];
            blocks.forEach(block => {
                const p = processBlock(block);
                if (p) parts.push(p);
            });
            return parts;
        };

        if (this.state.currentMode === 'portrait') {
            const s = this.state.portrait.static;
            if (Math.random() < 0.5) { const p = selectRandom(s['å¥—è£…']); if(p) allParts.push(p); }
            else { const p = [selectRandom(s['ä¸Šè£…']), selectRandom(s['ä¸‹è£…'])].filter(Boolean).join(", "); if(p) allParts.push(p); }
            if (Math.random() < 0.5) { const p = selectRandom(s['å®Œæ•´å‘å‹']); if(p) allParts.push(p); }
            else { const p = [selectRandom(s['å‰å‘']), selectRandom(s['åå‘'])].filter(Boolean).join(", "); if(p) allParts.push(p); }
            Object.keys(s).filter(c => !["å¥—è£…","ä¸Šè£…","ä¸‹è£…","å®Œæ•´å‘å‹","å‰å‘","åå‘"].includes(c)).forEach(id => { const p = selectRandom(s[id]); if (p) allParts.push(p); });
            allParts.push(...generateFromBlocks(this.state.portrait.dynamic));
        } else {
            allParts.push(...generateFromBlocks(this.state.custom.dynamic));
        }
        return allParts.filter(p => p).join(", ");
    },
    generateListToJson() {
        const lines = this.state.listToJson.content.split('\n').map(p => p.trim()).filter(p => p);
        const results = lines.map(line => ({ prompt: line }));
        return JSON.stringify(results, null, 2);
    },
    saveJsonToFile(jsonContent, filename) {
        if (!jsonContent || jsonContent === '[]') { this.notify("æ²¡æœ‰å†…å®¹å¯ä»¥ä¿å­˜ã€‚", 'error'); return; }
        const blob = new Blob([jsonContent], { type: 'application/json;charset=utf-8' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
        this.notify(`âœ… å·²æˆåŠŸä¿å­˜åˆ° ${filename}`, 'success');
    },
    batchGenerate() {
        const countInput = document.getElementById("batch-count");
        const count = parseInt(countInput.value, 10);
        if (isNaN(count) || count <= 0) { this.notify("è¯·è¾“å…¥æœ‰æ•ˆçš„ç”Ÿæˆæ•°é‡ã€‚", 'error'); return; }
        const prompts = Array.from({ length: count }, () => ({ prompt: this.generateSinglePrompt() }));
        const jsonContent = JSON.stringify(prompts, null, 2);
        this.saveJsonToFile(jsonContent, `æ‰¹é‡æç¤ºè¯_${count}ç»„_${this.state.currentMode}.json`);
    },
     notify(message, type = 'info', duration = 3000) {
        const box = document.getElementById('notification-box');
        if(!box) return;
        box.innerText = message;
        box.className = `show ${type}`;
        clearTimeout(box.timer);
        box.timer = setTimeout(() => { box.className = ''; }, duration);
    }
};

app.init();
</script>
</body>
</html>