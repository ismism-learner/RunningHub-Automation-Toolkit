<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æç¤ºè¯éšæœºç»„åˆå™¨</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f7f6;
            padding: 20px;
            color: #333;
        }
        .main-layout {
            display: flex;
            max-width: 1300px; 
            margin: 0 auto;
            gap: 20px;
        }
        .container {
            flex: 3; 
            min-width: 600px;
            background: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .sidebar {
            flex: 1; 
            min-width: 300px;
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .sidebar-header h2 {
            margin: 0;
            color: #1e88e5;
        }
        /* åŠ å·æŒ‰é’®æ ·å¼ */
        .btn-add-combination {
            background-color: #4caf50;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 20px;
            line-height: 1;
            cursor: pointer;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn-add-combination:hover {
            background-color: #45a049;
        }
        /* åˆ—è¡¨æ ·å¼ */
        #combination-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 50vh; 
            overflow-y: auto; 
            margin-bottom: 20px;
        }
        .combination-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .combination-item:hover {
            background-color: #f5f5f5;
        }
        .item-name {
            font-weight: bold;
            color: #333;
            flex-grow: 1;
            padding-right: 10px;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis; 
        }
        .item-delete {
            background: #f44336;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.2s;
        }
        .item-delete:hover {
            opacity: 1;
        }
        
        /* æŒ‰é’®å’Œè¾“å‡ºæ ·å¼ */
        h1 { text-align: center; color: #1e88e5; margin-bottom: 30px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; } 
        .input-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        .input-group textarea { width: 100%; height: 100px; padding: 10px; border: 1px solid #ccc; border-radius: 6px; resize: vertical; box-sizing: border-box; font-size: 14px; }
        .btn { display: block; width: 100%; padding: 12px; color: white; border: none; border-radius: 6px; font-size: 18px; cursor: pointer; transition: background-color 0.3s; box-sizing: border-box; text-align: center; }
        .btn-generate { background-color: #4caf50; }
        .btn-generate:hover { background-color: #45a049; }
        .btn-save { background-color: #ff9800; }
        .btn-save:hover { background-color: #fb8c00; }
        .btn-load { background-color: #2196f3; }
        .btn-load:hover { background-color: #1e88e5; }
        
        #output-area { flex: 1; padding: 15px; border: 2px solid #1e88e5; border-radius: 6px; background-color: #e3f2fd; word-break: break-all; font-size: 16px; font-weight: 500; }
        .note { margin-top: 20px; text-align: center; color: #888; font-size: 12px; }
        .button-group { display: flex; gap: 10px; margin-bottom: 20px; }
        #file-input-label { flex: 1; cursor: pointer; }
        #file-input { display: none; }

        /* æ‰¹é‡ç”ŸæˆåŒºåŸŸæ ·å¼ */
        .batch-area {
            border-top: 2px solid #e0e0e0;
            padding-top: 15px;
            margin-top: 15px;
        }
        .batch-area h3 {
            margin-top: 0;
            color: #00bcd4;
        }
        .batch-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .batch-input-group label {
            font-weight: bold;
            color: #555;
            white-space: nowrap;
        }
        .batch-input-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-sizing: border-box;
            text-align: center;
            /* æ ¸å¿ƒCSSä¿®æ”¹ï¼šéšè— type="number" çš„ä¸Šä¸‹ç®­å¤´ */
            -moz-appearance: textfield; /* Firefox */
        }
        /* Webkit (Chrome, Safari, Edge) */
        .batch-input-group input::-webkit-outer-spin-button,
        .batch-input-group input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .btn-batch-generate {
            background-color: #00bcd4; /* é’è‰² */
            font-size: 16px;
            padding: 10px;
        }
        .btn-batch-generate:hover {
            background-color: #00acc1;
        }

        /* é”™è¯¯/é€šçŸ¥çª—å£æ ·å¼ */
        #notification-box {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background-color: #333;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            max-width: 80%;
            font-size: 14px;
            pointer-events: none; /* å…è®¸ç‚¹å‡»ç©¿é€ */
        }
        #notification-box.show {
            opacity: 1;
            visibility: visible;
        }
        #notification-box.error {
            background-color: #f44336; /* çº¢è‰² */
        }
        #notification-box.success {
            background-color: #4CAF50; /* ç»¿è‰² */
        }
        #notification-box.info {
            background-color: #2196F3; /* è“è‰² */
        }
    </style>
</head>
<body>

<div class="main-layout">
    <div class="container">
        <h1>ğŸ¨ æç¤ºè¯éšæœºç»„åˆå™¨</h1>
        <p>å°†æ¯ç»„æç¤ºè¯ç²˜è´´åœ¨å¯¹åº”çš„æ–‡æœ¬æ¡†ä¸­ï¼Œæ¯è¡Œä¸€ä¸ªæç¤ºè¯ã€‚æ•°æ®å°†è‡ªåŠ¨ä¿å­˜åœ¨æµè§ˆå™¨ä¸­ã€‚</p>
        
        <div class="grid">
            <div class="input-group"><label for="ä¸ä¿®æ”¹çš„">1. ä¸ä¿®æ”¹çš„æç¤ºè¯ (åŸºåº•)</label><textarea id="ä¸ä¿®æ”¹çš„"></textarea></div>
            <div class="input-group"><label for="å¥—è£…">2. å¥—è£…</label><textarea id="å¥—è£…"></textarea></div>
            <div class="input-group"><label for="ä¸Šè£…">3. ä¸Šè£…</label><textarea id="ä¸Šè£…"></textarea></div>
            <div class="input-group"><label for="ä¸‹è£…">4. ä¸‹è£…</label><textarea id="ä¸‹è£…"></textarea></div>
            <div class="input-group"><label for="èº«ä½“é…é¥°">5. èº«ä½“é…é¥°</label><textarea id="èº«ä½“é…é¥°"></textarea></div>
            
            <div class="input-group"><label for="å‰å‘">6a. å‰å‘</label><textarea id="å‰å‘"></textarea></div>
            <div class="input-group"><label for="åå‘">6b. åå‘</label><textarea id="åå‘"></textarea></div>
            <div class="input-group"><label for="å®Œæ•´å‘å‹">6c. å®Œæ•´å‘å‹</label><textarea id="å®Œæ•´å‘å‹"></textarea></div>
            <div class="input-group"><label for="å‘è‰²">7. å‘è‰²</label><textarea id="å‘è‰²"></textarea></div>
            
            <div class="input-group"><label for="è¡¨æƒ…">8. è¡¨æƒ…</label><textarea id="è¡¨æƒ…"></textarea></div>
            
            <div class="input-group"><label for="å§¿åŠ¿">9. å§¿åŠ¿</label><textarea id="å§¿åŠ¿"></textarea></div>
            <div class="input-group"><label for="é•œå¤´">10. é•œå¤´</label><textarea id="é•œå¤´"></textarea></div>
        </div>

        <div class="button-group">
            <label for="file-input" id="file-input-label">
                <div class="btn btn-load">ğŸ“¤ åŠ è½½åˆ†ç±»æç¤ºè¯å’Œæ”¶è— (.txt)</div>
                <input type="file" id="file-input" accept=".txt" onchange="loadFromTXT(event)">
            </label>
            <button onclick="saveToTXT()" class="btn btn-save" style="flex: 1;">ğŸ’¾ ä¿å­˜åˆ†ç±»æç¤ºè¯å’Œæ”¶è— (.txt)</button>
        </div>

        <button onclick="generatePrompt()" class="btn btn-generate">ç”Ÿæˆç»„åˆæç¤ºè¯å¹¶å¤åˆ¶</button>

        <div style="margin-top: 30px; display: flex;">
            <div id="output-area" style="flex: 1;">ç‚¹å‡»â€œç”Ÿæˆç»„åˆæç¤ºè¯å¹¶å¤åˆ¶â€æŒ‰é’®...</div>
        </div>

        <div class="note">
            æ³¨æ„ï¼šæœè£…éƒ¨åˆ†ä¼šéšæœºé€‰æ‹© "å¥—è£…" æˆ– "ä¸Šè£… + ä¸‹è£…"ã€‚<br>
            **å‘å‹éƒ¨åˆ†ä¼šéšæœºé€‰æ‹© "å‰å‘ + åå‘" æˆ– "å®Œæ•´å‘å‹"**ã€‚<br>
            æ‰€æœ‰è¾“å…¥å†…å®¹ä¼šè‡ªåŠ¨ä¿å­˜åœ¨æ‚¨æµè§ˆå™¨çš„æœ¬åœ°å­˜å‚¨ (Local Storage) ä¸­ã€‚
        </div>
    </div>

    <div class="sidebar">
        <div class="sidebar-header">
            <h2>ç»„åˆæ”¶è—å¤¹</h2>
            <button onclick="promptAndSaveCombination()" class="btn-add-combination" title="æ‰‹åŠ¨æ·»åŠ æ–°ç»„åˆ">+</button>
        </div>
        <p style="font-size: 12px; color: #888;">ç‚¹å‡»åˆ—è¡¨é¡¹å¯å¤åˆ¶å†…å®¹</p>
        <ul id="combination-list">
        </ul>
        
        <div class="batch-area">
            <h3>ğŸš€ æ‰¹é‡ç”Ÿæˆå™¨</h3>
            <div class="batch-input-group">
                <label for="batch-count">ç”Ÿæˆæ•°é‡:</label>
                <input type="number" id="batch-count" value="10" min="1" max="1000" oninput="validateNumberInput(this)">
            </div>
            <button onclick="batchGenerateAndSaveToTXT()" class="btn btn-batch-generate">æ‰¹é‡ç”Ÿæˆå¹¶ä¿å­˜ä¸ºTXT</button>
        </div>
        </div>
</div>

<div id="notification-box"></div>

<script>
    /**
     * è‡ªå®šä¹‰é€šçŸ¥å‡½æ•° (å–ä»£ alert/confirm)
     */
    function notify(message, type = 'info', duration = 3000) {
        const box = document.getElementById('notification-box');
        box.innerText = message;
        box.className = `show ${type}`; 

        clearTimeout(box.timer);
        box.timer = setTimeout(() => {
            box.className = '';
        }, duration);
    }
    
    // ç¡®ä¿è¾“å…¥æ¡†åªåŒ…å«æ•°å­—
    function validateNumberInput(input) {
        input.value = input.value.replace(/[^0-9]/g, '');
        if (input.value === '' || parseInt(input.value, 10) === 0) {
            input.value = 1;
        }
    }

    const CATEGORIES = [
        "ä¸ä¿®æ”¹çš„", "å¥—è£…", "ä¸Šè£…", "ä¸‹è£…", "èº«ä½“é…é¥°", 
        "å‰å‘", "åå‘", "å®Œæ•´å‘å‹",
        "å‘è‰²", 
        "è¡¨æƒ…", 
        "å§¿åŠ¿", "é•œå¤´"
    ];
    const COMBINATIONS_KEY = "prompt_combinations"; 

    function loadData() {
        CATEGORIES.forEach(id => {
            const data = localStorage.getItem(`prompt_${id}`);
            if (data) {
                document.getElementById(id).value = data;
            }
        });
        renderCombinations(); 
    }

    function saveData() {
        CATEGORIES.forEach(id => {
            const textarea = document.getElementById(id);
            localStorage.setItem(`prompt_${id}`, textarea.value);
        });
    }
    
    function selectRandomPrompt(id) {
        const text = document.getElementById(id).value;
        const prompts = text.split('\n')
                            .map(p => p.trim())
                            .filter(p => p.length > 0);
        
        return prompts.length > 0 ? prompts[Math.floor(Math.random() * prompts.length)] : "";
    }

    function loadCombinations() {
        const data = localStorage.getItem(COMBINATIONS_KEY);
        try {
            return data ? JSON.parse(data) : [];
        } catch (e) {
            console.error("Error loading combinations from local storage:", e);
            return [];
        }
    }

    function saveCombinations(combinations) {
        localStorage.setItem(COMBINATIONS_KEY, JSON.stringify(combinations));
    }

    // ä¿æŒä½¿ç”¨ prompt æ”¶é›†è¾“å…¥ï¼Œå› ä¸ºè¿™æ˜¯è·å–ç”¨æˆ·è¾“å…¥æ–‡æœ¬çš„æœ€ç®€æ´æ–¹å¼
    function promptAndSaveCombination() {
        const defaultName = `ç»„åˆ #${Date.now() % 10000}`;
        
        const promptText = prompt("è¯·è¾“å…¥æ‚¨æƒ³æ”¶è—çš„ç»„åˆæç¤ºè¯:", document.getElementById("output-area").innerText.trim());

        if (promptText === null || !promptText.trim()) {
            return; 
        }

        const name = prompt("è¯·ä¸ºæ­¤ç»„åˆå‘½åï¼š", defaultName);

        if (name) {
            const combinations = loadCombinations();
            const finalName = name.trim() || defaultName;
            combinations.push({ 
                name: finalName, 
                prompt: promptText.trim() 
            });
            saveCombinations(combinations);
            renderCombinations();
            notify(`ç»„åˆ "${finalName}" å·²æˆåŠŸæ”¶è—ï¼`, 'success', 2000);
        }
    }

    function renderCombinations() {
        const listElement = document.getElementById("combination-list");
        listElement.innerHTML = ''; 
        const combinations = loadCombinations();

        if (combinations.length === 0) {
            listElement.innerHTML = '<li style="color: #999; font-size: 14px;">æš‚æ— æ”¶è—çš„ç»„åˆã€‚</li>';
            return;
        }

        combinations.forEach((item, index) => {
            const li = document.createElement('li');
            li.className = 'combination-item';
            li.title = item.prompt; 
            li.innerHTML = `
                <span class="item-name">${item.name}</span>
                <button class="item-delete" data-index="${index}">åˆ é™¤</button>
            `;

            li.onclick = (e) => {
                if (e.target.className.includes('item-delete')) return; 

                navigator.clipboard.writeText(item.prompt).then(() => {
                    notify(`âœ… ç»„åˆ "${item.name}" å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼`, 'success', 2000);
                }).catch(err => {
                    console.error('å¤åˆ¶å¤±è´¥:', err);
                    notify('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ï¼', 'error', 4000);
                });
            };

            const deleteButton = li.querySelector('.item-delete');
            deleteButton.onclick = (e) => {
                e.stopPropagation(); 
                // â­ï¸ ä¸€é”®åˆ é™¤ï¼Œç”¨æˆ·éœ€è‡ªè´Ÿåæœ (å¦‚æ‚¨æ‰€æ„¿)
                deleteCombination(index);
                notify(`ç»„åˆ "${item.name}" å·²åˆ é™¤ã€‚`, 'info', 2000);
            };
            
            listElement.appendChild(li);
        });
    }

    function deleteCombination(index) {
        let combinations = loadCombinations();
        if (index >= 0 && index < combinations.length) {
            combinations.splice(index, 1); 
            saveCombinations(combinations);
            renderCombinations();
        }
    }

    /**
     * ä¿å­˜æ‰€æœ‰åˆ†ç±»æç¤ºè¯å’Œç»„åˆæ”¶è—å¤¹åˆ°TXTæ–‡ä»¶
     * â­ï¸ åªä½¿ç”¨ç®€æ´æ ¼å¼ä¿å­˜: == id ==
     */
    function saveToTXT() {
        saveData(); 

        let content = "";
        let hasContent = false;

        // 1. ä¿å­˜åˆ†ç±»æç¤ºè¯ (ç®€æ´æ ¼å¼: == id ==)
        CATEGORIES.forEach(id => {
            const textarea = document.getElementById(id);
            if (textarea.value.trim().length > 0) {
                content += `== ${id} ==\n`; // ç®€æ´å¤´éƒ¨
                content += textarea.value.trim() + "\n\n";
                hasContent = true;
            }
        });
        
        // 2. ä¿å­˜ç»„åˆæ”¶è—å¤¹å†…å®¹
        const combinations = loadCombinations();
        if (combinations.length > 0) {
            content += "\n\n================================\n";
            content += "== ç»„åˆæ”¶è—å¤¹ (COLLECTION) ==\n";
            content += "================================\n\n";

            combinations.forEach((item, index) => {
                content += `[æ”¶è—ç»„åˆ NO.${index + 1} - åç§°: ${item.name}]\n`;
                content += item.prompt + "\n\n";
            });
            hasContent = true;
        }

        if (!hasContent) {
            notify('æ²¡æœ‰å†…å®¹å¯ä»¥ä¿å­˜ã€‚è¯·åœ¨åˆ†ç±»æ–‡æœ¬æ¡†æˆ–æ”¶è—å¤¹ä¸­è¾“å…¥å†…å®¹ã€‚', 'error', 3000);
            return;
        }

        const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'æç¤ºè¯_å¤‡ä»½_åˆ†ç±»å’Œæ”¶è—.txt'; 
        
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);

        notify('âœ… åˆ†ç±»å’Œæ”¶è—å·²ä¿å­˜åˆ° TXT æ–‡ä»¶ã€‚', 'success', 3000);
    }

    /**
     * æå–åŠŸèƒ½ï¼šä»TXTæ–‡ä»¶åŠ è½½åˆ†ç±»æç¤ºè¯å’Œç»„åˆæ”¶è—å¤¹
     * â­ï¸ åªè¯†åˆ«ç®€æ´æ ¼å¼: == id ==ï¼Œä»¥åŠç»„åˆæ”¶è—å¤¹å¤´éƒ¨ã€‚
     */
    function loadFromTXT(event) {
        const file = event.target.files[0];
        if (!file) { return; }

        const reader = new FileReader();
        reader.onload = function(e) {
            const text = e.target.result;
            const lines = text.split('\n');
            let currentCategory = null;
            const categoryContents = {};
            let inCombinationsArea = false; 
            let newCombinations = []; 
            let currentCombination = null; 
            let categoriesActuallyLoaded = 0; 

            CATEGORIES.forEach(id => { categoryContents[id] = []; });

            lines.forEach(line => {
                const trimmedLine = line.trim();
                if (trimmedLine.length === 0) return; 

                const combinationAreaMatch = trimmedLine.match(/^== ç»„åˆæ”¶è—å¤¹ \(COLLECTION\) ==$/);
                const categoryMatch = trimmedLine.match(/^== (.*?) ==$/);  // â­ï¸ ç»Ÿä¸€è¯†åˆ«ç®€æ´æ ¼å¼
                const combinationStartMatch = trimmedLine.match(/^\[æ”¶è—ç»„åˆ NO.\d+ - åç§°: (.*?)\]$/); 

                // 1. æ£€æµ‹åˆ°ç»„åˆæ”¶è—å¤¹åŒºåŸŸçš„å¼€å§‹
                if (combinationAreaMatch) {
                    inCombinationsArea = true;
                    currentCategory = null; 
                    return; 
                }

                let categoryMatchResult = null;
                if (categoryMatch) {
                     // æ’é™¤åŒ¹é…åˆ°åˆ†éš”ç¬¦ï¼ˆç»„åˆæ”¶è—å¤¹ï¼Œæˆ–çº¯åˆ†éš”çº¿ï¼‰çš„æƒ…å†µ
                    const matchedContent = categoryMatch[1].trim();
                    if (matchedContent !== 'ç»„åˆæ”¶è—å¤¹ (COLLECTION)' && !matchedContent.includes('=')) {
                        categoryMatchResult = matchedContent;
                    }
                }
                
                // 2. æ£€æµ‹åˆ°åˆ†ç±»å¤´éƒ¨
                if (categoryMatchResult) {
                    const categoryId = categoryMatchResult.trim();
                    if (CATEGORIES.includes(categoryId)) {
                        currentCategory = categoryId;
                    } else {
                        currentCategory = null; // éæ³•çš„åˆ†ç±» IDï¼Œå¿½ç•¥è¯¥å—å†…å®¹
                    }
                    inCombinationsArea = false; 
                    currentCombination = null;
                    return; 
                } 
                
                // 3. å¤„äºç»„åˆæ”¶è—å¤¹åŒºåŸŸï¼Œå¤„ç†ç»„åˆé¡¹
                if (inCombinationsArea) {
                    if (combinationStartMatch) {
                        // ç»“æŸä¸Šä¸€ä¸ªç»„åˆï¼Œå¼€å§‹æ–°çš„ç»„åˆ
                        if (currentCombination && currentCombination.prompt.trim()) {
                            newCombinations.push(currentCombination);
                        }
                        currentCombination = { 
                            name: combinationStartMatch[1], 
                            prompt: "" 
                        };
                    } else if (currentCombination) {
                        // ç§¯ç´¯ç»„åˆçš„æç¤ºè¯å†…å®¹
                        currentCombination.prompt += (currentCombination.prompt.length > 0 ? "\n" : "") + trimmedLine;
                    }
                } 
                // 4. å¤„äºåˆ†ç±»æç¤ºè¯åŒºåŸŸ
                else if (currentCategory) {
                    // ç§¯ç´¯åˆ†ç±»æç¤ºè¯å†…å®¹
                    categoryContents[currentCategory].push(trimmedLine);
                }
            });

            // ç¡®ä¿ä¿å­˜æœ€åä¸€ä¸ªè§£æçš„ç»„åˆ
            if (currentCombination && currentCombination.prompt.trim()) {
                newCombinations.push(currentCombination);
            }

            // 1. åŠ è½½åˆ†ç±»å†…å®¹
            CATEGORIES.forEach(id => {
                const contentLines = categoryContents[id];
                document.getElementById(id).value = contentLines.join('\n');
                if (contentLines.length > 0) {
                    categoriesActuallyLoaded++; 
                }
            });
            saveData(); 

            // 2. åŠ è½½ç»„åˆæ”¶è—å¤¹å†…å®¹ (è¿½åŠ æ¨¡å¼)
            if (newCombinations.length > 0) {
                let existingCombinations = loadCombinations();
                existingCombinations.push(...newCombinations);
                saveCombinations(existingCombinations);
                renderCombinations();
            }
            
            // æœ€ç»ˆé€šçŸ¥ï¼šåŸºäºå®é™…åŠ è½½çš„å†…å®¹æ•°é‡åˆ¤æ–­æˆåŠŸ/å¤±è´¥
            if (categoriesActuallyLoaded > 0 || newCombinations.length > 0) {
                notify(`âœ… æ–‡ä»¶è¯»å–å®Œæˆï¼Œå·²æ›´æ–° ${categoriesActuallyLoaded} ä¸ªåˆ†ç±»å’Œå¯¼å…¥ ${newCombinations.length} ä¸ªæ”¶è—ç»„åˆã€‚`, 'success', 4000);
            } else {
                 notify('âš ï¸ æ–‡ä»¶ä¸­æœªæ£€æµ‹åˆ°åˆ†ç±»æˆ–æ”¶è—ç»„åˆå†…å®¹ã€‚', 'info', 3000);
            }
            event.target.value = ''; // æ¸…ç©ºæ–‡ä»¶è¾“å…¥ï¼Œå…è®¸å†æ¬¡é€‰æ‹©åŒä¸€æ–‡ä»¶
        };

        reader.readAsText(file);
    }
    
    // æ ¸å¿ƒç»„åˆé€»è¾‘ (ä¿æŒä¸å˜)
    function generateSinglePrompt() {
        saveData(); 

        const allParts = [];
        const immutable = selectRandomPrompt("ä¸ä¿®æ”¹çš„");
        if (immutable) {
            allParts.push(immutable);
        }

        let clothingPrompt = "";
        const selectSet = Math.random() < 0.5;

        if (selectSet) {
            clothingPrompt = selectRandomPrompt("å¥—è£…");
        } else {
            const top = selectRandomPrompt("ä¸Šè£…");
            const bottom = selectRandomPrompt("ä¸‹è£…");
            const tempParts = [top, bottom].filter(p => p);
            clothingPrompt = tempParts.join(", ");
        }

        if (clothingPrompt) {
            allParts.push(clothingPrompt);
        }
        
        let hairstylePrompt = "";
        const useFullHairstyle = Math.random() < 0.5;

        if (useFullHairstyle) {
            hairstylePrompt = selectRandomPrompt("å®Œæ•´å‘å‹");
        } else {
            const front = selectRandomPrompt("å‰å‘");
            const back = selectRandomPrompt("åå‘");
            const tempParts = [front, back].filter(p => p);
            hairstylePrompt = tempParts.join(", ");
        }

        if (hairstylePrompt) {
            allParts.push(hairstylePrompt);
        }

        const accessoryCategories = ["èº«ä½“é…é¥°", "å‘è‰²", "è¡¨æƒ…", "å§¿åŠ¿", "é•œå¤´"]; 
        accessoryCategories.forEach(id => {
            const prompt = selectRandomPrompt(id);
            if (prompt) {
                allParts.push(prompt);
            }
        });

        return allParts.join(", ");
    }
    
    // å•æ¬¡ç”Ÿæˆå¹¶å¤åˆ¶çš„å‡½æ•°
    function generatePrompt() {
        const finalPrompt = generateSinglePrompt();
        const outputArea = document.getElementById("output-area");
        outputArea.innerText = finalPrompt || "æœªç”Ÿæˆä»»ä½•æç¤ºè¯ï¼Œè¯·æ£€æŸ¥è¾“å…¥æ˜¯å¦ä¸ºç©ºã€‚";

        if (finalPrompt) {
            navigator.clipboard.writeText(finalPrompt).then(() => {
                notify("âœ… æç¤ºè¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼", 'success', 2000);
            }).catch(err => {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                notify('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ï¼', 'error', 4000);
            });
        }
    }

    // æ‰¹é‡ç”Ÿæˆå¹¶ä¿å­˜ä¸ºTXTçš„å‡½æ•°
    function batchGenerateAndSaveToTXT() {
        saveData(); 

        const countInput = document.getElementById("batch-count");
        let count = parseInt(countInput.value, 10);
        const MAX_COUNT = 1000;

        if (isNaN(count) || count <= 0) {
            notify("è¯·è¾“å…¥ä¸€ä¸ªæœ‰æ•ˆçš„ç”Ÿæˆæ•°é‡ (å¤§äº 0)ã€‚", 'error', 3000);
            countInput.value = 1; 
            return;
        }

        if (count > MAX_COUNT) {
            notify(`âš ï¸ æ•°é‡ ${count} è¶…è¿‡å»ºè®®æœ€å¤§å€¼ ${MAX_COUNT}ã€‚è¯·æ‰‹åŠ¨ä¿®æ”¹ã€‚`, 'error', 4000);
            return;
        }
        
        let batchContent = `\n`;
        const separator = "=== ç»„åˆæç¤ºè¯ - NO. "; 

        for (let i = 1; i <= count; i++) {
            const prompt = generateSinglePrompt();
            batchContent += `${separator}${i} ===\n`; 
            batchContent += prompt + "\n\n";
        }
        
        batchContent = batchContent.trim();

        if (!batchContent) {
            notify("æœªèƒ½ç”Ÿæˆä»»ä½•æç¤ºè¯ï¼Œè¯·æ£€æŸ¥è‡³å°‘æœ‰ä¸€ä¸ªåˆ†ç±»æœ‰è¾“å…¥å†…å®¹ã€‚", 'error', 3000);
            return;
        }

        const blob = new Blob([batchContent], { type: 'text/plain;charset=utf-8' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `æ‰¹é‡æç¤ºè¯ç»„åˆ_${count}ç»„.txt`;
        
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);

        notify(`âœ… å·²æˆåŠŸæ‰¹é‡ç”Ÿæˆ ${count} ç»„æç¤ºè¯å¹¶ä¿å­˜ã€‚`, 'success', 3000);
    }

    window.onload = loadData;
</script>

</body>
</html>
